<?php

// I hate notice errors
ini_set('error_reporting', ini_get('error_reporting') & ~E_NOTICE & ~E_DEPRECATED);

require_once DRUPAL_ROOT . '/sites/all/modules/_custom/sirius_teamsters631/sirius_teamsters631.menu.inc';
require_once DRUPAL_ROOT . '/sites/all/modules/_custom/sirius_teamsters631/sirius_teamsters631.ebnotify.inc';
require_once DRUPAL_ROOT . '/sites/all/modules/_custom/sirius_teamsters631/sirius_teamsters631.permission.inc';
require_once DRUPAL_ROOT . '/sites/all/modules/_custom/sirius_teamsters631/sirius_teamsters631.badge.inc';
require_once DRUPAL_ROOT . '/sites/all/modules/_custom/sirius_teamsters631/sirius_teamsters631.log.inc';
require_once DRUPAL_ROOT . '/sites/all/modules/_custom/sirius_teamsters631/sirius_teamsters631.feed_hours_check.inc';
require_once DRUPAL_ROOT . '/sites/all/modules/_custom/sirius_teamsters631/sirius_teamsters631.banner.inc';
require_once DRUPAL_ROOT . '/sites/all/modules/_custom/sirius_teamsters631/sirius_teamsters631.server_switch.inc';

/***
 * Implements hook_sirius_wizard_info()
 */

function sirius_teamsters631_sirius_wizard_info() {
  $items = array();

  // $items += sirius_ledger_feed_charges_info();
  $items += sirius_teamsters631_feed_hours_check_info();

  return $items;
}

/**
 * Implements hook_taxonomy_term_update() 
 */

function sirius_teamsters631_taxonomy_term_update($term) {
  $vid = $term->vid;
  $vocabulary = taxonomy_vocabulary_load($vid);
  if ($vocabulary->machine_name == 'sirius_member_status') { sirius_teamsters631_taxonomy_term_update_ebnotify($term); }
}

/**
 * Implements hook_sirius_node_tab_content_alter
 * 
 * If we are an apprentice at the uh or vice-versa, tell them where they should get their dispatches.
 */

function sirius_teamsters631_sirius_node_tab_content_alter($result, $context) {
	// Must be in either TC or UH
	$which = sirius_teamsters631_banner_which();
	if (!$which) { return; } 

	// Must be in one of he dispatch tabs
	$in_tab_name = $context['in_tab_name'];
	if (!preg_match('/sirius_worker_dispatches\//', $in_tab_name)) { return; }

	// Get the member names
	$worker_node = $context['node'];
	$ms_names = sirius_taxonomy_load('sirius_member_status', 'tid', 'name');
	$is_apprentice = FALSE;
	if ($worker_node->field_sirius_member_status['und']) {
		foreach ($worker_node->field_sirius_member_status['und'] as $record) {
			$ms_name = $ms_names[$record['tid']];
			if (preg_match('/apprentice/i', $ms_name)) {
				$is_apprentice = TRUE;
			}
		}
	}

	if ($which == 'tc' && !$is_apprentice) {
		drupal_set_message("All dispatch for non-apprentice workers will be performed by the Union Hall.<br /><br />Please use the link at the top of the page to switch to the Union Hall's site in order to review your current dispatches or set your dispatch preferences.", 'warning');
	}

	if ($which == 'uh' && $is_apprentice) {
		drupal_set_message("As an apprentice, all dispatch (except bullpens) will be performed by the Training Center.<br /><br />Please use the link at the top of the page to switch to the Training Center's site in order to review your current dispatches or set your dispatch preferences.", 'warning');
	}
}